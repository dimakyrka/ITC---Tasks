<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.setText('Сохранить').show().onClick(saveAndClose);

    // Получаем актуальные задачи из URL
    const urlParams = new URLSearchParams(window.location.search);
    let tasks = [];
    
    try {
        const tasksJson = urlParams.get('tasks');
        if (tasksJson) {
            tasks = JSON.parse(decodeURIComponent(tasksJson));
            if (!Array.isArray(tasks)) tasks = [];
        }
    } catch (e) {
        console.error("Ошибка загрузки задач:", e);
    }

    // Функция отображения задач
    function renderTasks() {
        const container = document.getElementById('tasksList');
        if (!container) return;
        
        container.innerHTML = tasks.map((task, index) => `
            <div class="task">
                <span>${task}</span>
                <button onclick="deleteTask(${index})">×</button>
            </div>
        `).join('');
    }

    // Добавление новой задачи
    function addTask() {
        const input = document.getElementById('newTask');
        const text = input.value.trim();
        if (text) {
            tasks.push(text);
            input.value = '';
            renderTasks();
        }
    }

    // Удаление задачи
    function deleteTask(index) {
        tasks.splice(index, 1);
        renderTasks();
    }

    // Сохранение и закрытие
    function saveAndClose() {
        tg.sendData(JSON.stringify({
            user_id: urlParams.get('user_id'),
            tasks: tasks,
            timestamp: new Date().toISOString()
        }));
        tg.close();
    }

    // Первоначальная отрисовка
    renderTasks();
</script>
